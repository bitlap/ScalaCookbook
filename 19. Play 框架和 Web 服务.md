# 19. Play 框架和 Web 服务

本章的小节展示了使用Scala开发Web服务，包括如何处理服务器端的HTTP请求，如何在JSON和Scala对象之间进行转换，以及如何编写客户端的HTTP请求。

到2021年，有一些很棒的库可以用Scala进行服务器端开发，可以在Awesome Scala列表(*https://oreil.ly/rC08K*)中找到这些库。本章重点介绍Play框架（Play），因为它很流行，支持度高，而且相对容易上手，特别是如果以前使用过Ruby on Rails这样的框架的话就更简单了。

注意，在本书编写之时，Play还没有更新到支持Scala 3。因此，在本章中看到的Play示例使用的是Scala 2语法。也就是说，Play的API已经相当稳定，可以追溯到2013年和*Scala Cookbook*第一版的发布，因此，当Play支持Scala 3时，这些例子有望很好地转化为支持Scala 3。

本章的初始小节侧重于使用 Play 的服务器端开发。这些小节包括：

- 小节19.1，创建第一个Play项目
- 小节19.2，创建一个新的端点，即一个服务器端REST服务的URL
- 小节19.3，从Play GET请求返回一个JSON
- 小节19.4，将Scala对象转换为JSON
- 小节19.5，将JSON转换为Scala对象

然后，最后两个小节展示了可用于服务器端或客户端开发的技术：

- 小节19.6，在Play框架外使用Play JSON库
- 小节19.7，使用sttp HTTP客户端

## 19.1 创建一个Play框架项目

### 问题

这一章大部分小节使用Play 框架（Play），如果之前没用过Play，需要知道如何创建一个新的Play项目。

### 解决方案

创建一个新的Play项目的最简单方法是使用sbt种子模板：

```
    $ sbt new playframework/play-scala-seed.g8
```

当该命令运行时，只需要给它一个项目名称和组织名称，然后 **cd** 进入新的目录，如下所示：

```
    $ sbt new playframework/play-scala-seed.g8 
    [info] Set current project to play ...
    This template generates a Play Scala project

    name [play-scala-seed]: hello-world 
    organization [com.example]: com.alvinalexander

    Template applied in hello-world

    $ cd hello-world
```

然后在该项目目录下，运行 **sbt run** 命令：

```
    $ sbt run 
    // a LOT of output here ...
    [info] loading settings for project hello-world-build from plugins.sbt ... 
    [info] loading settings for project root from build.sbt ...
    [info] set current project to hello-world ...
    
    --- (Running the application, auto-reloading is enabled) --
    [info] p.c.s.AkkaHttpServer - Listening for HTTP on /0:0:0:0:0:0:0:0:9000 
    (Server started, use Enter to stop and go back to the console...)
```

第一次运行该命令时，会有很多输出，如果以最后三行结束，这表明Play服务器在9000端口运行：

现在，当在浏览器中打开 *http://localhost:9000* URL时，会看到一个 "Welcome to Play "的网页，看起来像图19-1中的页面那样。

![f19-1](./f19-1.png)

图19-1，*"欢迎来使用Play！"欢迎页*

如果需要在9000以外的端口运行Play，请在你的操作系统命令行中使用这个命令：

```
    $ sbt "run 8080"
```

或者在sbt shell中使用如下命令：

```
    sbt> run 8080
```

### 讨论

一个Play应用程序由以下组件组成：

- sbt *build.sbt* 文件，包含应用程序的依赖和其他配置信息。
- 放在 *app/controllers* 文件夹中的控制器。
- 在app/models文件夹中的模型。这个文件夹通常不会自动创建。
- 包含HTML、JavaScript、CSS和Scala代码片段的模板被放在 *app/views* 文件夹中。
- 一个 *conf/routes* 文件，里面有将URI和HTTP方法映射到控制器方法。

其他重要的文件包括：

- *conf/application.conf* 文件中的应用程序配置信息。这里包括关于如何访问数据库的信息。
- 在 *conf/evolutions* 文件夹中的数据库演化脚本。
- 模板文件的设计资源被放在 *public/images* 、*public/javascripts* 和 *public/stylesheets* 文件夹中。

因为本章是关于构建Web服务的，而不是Web 1.0应用程序，所以主要关注的是这些目录和文件：

- *conf/routes* 路由文件
- 在 *app/controllers* 自定义的控制器

#### *conf/routes* 文件

要了解项目中的文件，首先看conf/routes文件。当前的Play 2.8模板创建了一个具有以下内容的文件：

```
    # Routes 
    # This file defines all application routes (Higher priority routes first) 
    # https://www.playframework.com/documentation/latest/ScalaRouting
    
    # An example controller showing a sample home page 
    GET / controllers.HomeController.index
    
    # Map static resources from the /public folder to the /assets URL path 
    GET /assets/*file controllers.Assets.versioned(path="/public", file: Asset)
```

要了解欢迎页面是如何显示的，这是该文件中这重要的一行：

```
    GET / controllers.HomeController.index
```

这一行可以理解为："当以HTTP GET方法请求/ URI上时，调用 *控制器* 包中的 **HomeController** 类中定义的 **index** 方法"。如果使用过Ruby on Rails等其他框架，就见过这种东西。它将特定的HTTP方法（如GET或POST）和URI绑定到一个类中的方法。